# ğŸ—ºï¸ RealSense D455 + OctoMap å®æ—¶è§‚æµ‹

é«˜æ€§èƒ½ 3D åŠ¨æ€è§‚æµ‹ç³»ç»Ÿã€‚RealSense D455 ç‚¹äº‘ â†’ OctoMap å®æ—¶ 3D æ˜¾ç¤ºã€‚

> **ç³»ç»Ÿæ¨¡å¼**: **åŠ¨æ€è§‚æµ‹** - åªæ˜¾ç¤ºå½“å‰è§†é‡å†…çš„ç‰©ä½“ï¼Œç§»èµ°åè‡ªåŠ¨æ¶ˆå¤±ï¼ˆä¸ç§¯ç´¯å†å²ï¼‰  
> **æ€§èƒ½æŒ‡æ ‡**: 5-10 Hz å®æ—¶æ›´æ–°ï¼ˆç›¸æ¯”ä¼˜åŒ–å‰çš„ 0.5 Hzï¼Œæé€Ÿ 10 å€ï¼‰

## âš¡ å¿«é€Ÿå¼€å§‹ï¼ˆ3 è¡Œå‘½ä»¤ï¼‰

```bash
cd /home/yq/ros2realsense
source install/setup.bash
ros2 launch realsense2_camera rs_octomap.launch.py
```

**ç¬¬ä¸€æ¬¡è¿è¡Œï¼Ÿ** æ„å»ºé¡¹ç›®ï¼š
```bash
cd /home/yq/ros2realsense
colcon build --symlink-install
```

## ğŸš€ å¯åŠ¨æ–¹å¼

### æ–¹å¼ 1: äº¤äº’å¼å¯åŠ¨ï¼ˆæ¨èï¼‰
```bash
./start_realsense_octomap.sh
```
é€‰æ‹©é¢„è®¾é…ç½®æˆ–è‡ªå®šä¹‰å‚æ•°ï¼Œæ”¯æŒåœ°é¢é«˜åº¦è¿‡æ»¤ã€‚

### æ–¹å¼ 2: å¿«é€Ÿå¯åŠ¨
```bash
# å¿«é€Ÿæ¨¡å¼ (0.2m ä½“ç´ ï¼Œ5-10 Hz)
ros2 launch realsense2_camera rs_octomap.launch.py

# æ ‡å‡†æ¨¡å¼ (0.15m ä½“ç´ ï¼Œ3-5 Hz)
ros2 launch realsense2_camera rs_octomap.launch.py resolution:=0.15

# é«˜ç²¾åº¦æ¨¡å¼ (0.1m ä½“ç´ ï¼Œ1-3 Hz)
ros2 launch realsense2_camera rs_octomap.launch.py resolution:=0.1
```

### æ–¹å¼ 3: æ—  RVizï¼ˆçº¯å¤„ç†ï¼‰
```bash
ros2 launch realsense2_camera rs_octomap.launch.py enable_rviz:=false
```

## ğŸ“Š æ€§èƒ½é…ç½®

### ç›¸æœºé…ç½®
- **åˆ†è¾¨ç‡**: 1280x720 @ 30 FPSï¼ˆå½©è‰² + æ·±åº¦ï¼‰
- **Decimation**: 4xï¼ˆè¾“å‡º 320x180 ç‚¹äº‘ï¼‰
- **è·ç¦»è£å‰ª**: 0-3 ç±³ï¼ˆclip_distanceï¼‰

### OctoMap æ¨¡å¼

| æ¨¡å¼ | åˆ†è¾¨ç‡ | ä½“ç´ æ•° | å¸§ç‡ | ç”¨é€” |
|------|--------|---------|------|------|
| ğŸš€ **å¿«é€Ÿ** | 0.2m | 8x å°‘ | 5-10 Hz | å®æ—¶å¯¼èˆª/æ¼”ç¤º |
| âš–ï¸ **æ ‡å‡†** | 0.15m | 4x å°‘ | 3-5 Hz | ä¸€èˆ¬åº”ç”¨ |
| ğŸ¯ **ç²¾åº¦** | 0.1m | æ­£å¸¸ | 1-3 Hz | ç²¾ç¡®å»ºå›¾ |

**å…³é”®ä¼˜åŒ–**ï¼š
- âœ… **åŠ¨æ€è§‚æµ‹æ¨¡å¼**ï¼ˆä¸ç§¯ç´¯å†å²ï¼Œåªæ˜¾ç¤ºå½“å‰ç‰©ä½“ï¼‰
- âœ… ç¦ç”¨ RANSAC åœ°é¢æå–ï¼ˆèŠ‚çœ 70% è®¡ç®—æ—¶é—´ï¼‰
- âœ… Decimation=4 å‡å°‘ç‚¹äº‘æ•°é‡ï¼ˆ~100k â†’ ~25k ç‚¹/å¸§ï¼‰
- âœ… clip_distance=3.0m è£å‰ªè¿œè·ç¦»ç‚¹
- âœ… **è¶…å¿«æ¸…é™¤æ¦‚ç‡**ï¼ˆhit=0.97, miss=0.01, min=0.49 + compress_map=trueï¼‰â†’ ç‰©ä½“ **<1 ç§’æ¶ˆå¤±** âš¡

## âœ… ç³»ç»Ÿè¦æ±‚

- **ç¡¬ä»¶**: RealSense D455ï¼ˆUSB 3.0ï¼‰ã€4GB+ RAM
- **ç³»ç»Ÿ**: Ubuntu 22.04 + ROS 2 Humble
- **ä¾èµ–**: OctoMapã€RealSense SDK 2.x

**å®‰è£…ä¾èµ–**:
```bash
sudo apt-get install liboctomap-dev octomap-tools
colcon build --symlink-install
```

## ğŸ“ˆ æ€§èƒ½æµ‹è¯•

è¿è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•ï¼š
```bash
./run_performance_test.sh
```

è¾“å‡ºæŠ¥å‘Šï¼š`octomap_performance_report.txt`

## ğŸ“ ROS è¯é¢˜

| è¯é¢˜ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `/occupied_cells_vis_array` | MarkerArray | 3D å ç”¨ä½“ç´  |
| `/projected_map` | OccupancyGrid | 2D ä¿¯è§†å›¾ |
| `/camera/depth/color/points` | PointCloud2 | è¾“å…¥ç‚¹äº‘ |

## ğŸ”§ å‚æ•°è°ƒèŠ‚

### ç‚¹äº‘è·ç¦»è¿‡æ»¤

RealSense ç‚¹äº‘å¯åœ¨æºå¤´è£å‰ªè·ç¦»ï¼Œå‡å°‘æ•°æ®é‡ï¼š

```bash
# å°†æœ€å¤§è·ç¦»é™åˆ¶åœ¨ 3 ç±³
ros2 launch realsense2_camera rs_octomap.launch.py clip_distance:=3.0

# ç¦ç”¨è·ç¦»è£å‰ª
ros2 launch realsense2_camera rs_octomap.launch.py clip_distance:=-1
```

**è¯´æ˜**ï¼š
- `clip_distance` æ˜¯ **RealSense è¾“å‡ºä¾§**çš„è¿‡æ»¤ï¼ˆæ•ˆç‡é«˜ï¼‰
- OctoMap ä¼šé¢å¤–è¿›è¡Œ `sensor_model.min/max_range` è¿‡æ»¤
- ä¸¤å±‚è¿‡æ»¤å¯å‡å°‘ CPU å‹åŠ›å¹¶é™ä½å†…å­˜å ç”¨

### å¯åŠ¨å‚æ•°æ€»è§ˆ

```bash
ros2 launch realsense2_camera rs_octomap.launch.py \
  clip_distance:=3.0 \           # RealSense æœ€å¤§è·ç¦»è£å‰ªï¼ˆ-1=ç¦ç”¨ï¼‰
  resolution:=0.2 \              # OctoMap åˆ†è¾¨ç‡ï¼ˆç±³ï¼‰
  pointcloud_max_z:=2.0 \        # æœ€å¤§é«˜åº¦è¿‡æ»¤ï¼ˆç±³ï¼‰
  colored_map:=false \           # RGB å¤„ç†ï¼ˆtrue/falseï¼‰
  filter_ground:=false \         # RANSAC è¿‡æ»¤ï¼ˆtrue/falseï¼‰
  camera_height:=0.5 \           # ç›¸æœºç¦» base_link çš„é«˜åº¦
  enable_rviz:=true             # å¯ç”¨ RVizï¼ˆtrue/falseï¼‰
```

## ğŸ› æ•…éšœæ’æŸ¥

### ç›¸æœºæ£€æµ‹å¤±è´¥

**ç›¸æœºæ£€æµ‹å¤±è´¥ï¼Ÿ**
```bash
# æ£€æŸ¥è®¾å¤‡
rs-enumerate-devices

# æ£€æŸ¥ USB
lsusb | grep Intel
```

### åœ°å›¾ä¸å åŠ  / è½¬å‘å°±ä¸¢å¤±åœ°å›¾

âš ï¸ **å½“å‰ç³»ç»Ÿä½¿ç”¨é™æ€ TF**ï¼šå¦‚æœæœºå™¨äººç§»åŠ¨ï¼Œåœ°å›¾ä¼š"è·Ÿç€æœºå™¨äººèµ°"ï¼Œä¸ä¼šå åŠ ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. **é™æ­¢ç›¸æœº** âœ… ç°åœ¨çš„é…ç½®ï¼Œåœ°å›¾ä¼šç´¯ç§¯åœ¨å±€éƒ¨ç›¸æœºåæ ‡ç³»
2. **ç§»åŠ¨æœºå™¨äºº** âš ï¸ éœ€è¦é‡Œç¨‹è®¡/SLAM æä¾› `map â†’ base_link` çš„åŠ¨æ€ TF
   - å»ºè®®ä½¿ç”¨ `robot_localization`ã€`rtabmap`ã€æˆ– `cartographer`
   - è¿™æ · OctoMap ä¼šè‡ªåŠ¨ç´¯ç§¯åœ¨å…¨å±€ `map` åæ ‡ç³»

**ç›®å‰ TF ç»“æ„**ï¼š
```
map (å›ºå®š)
 â””â”€â”€ base_link (å›ºå®š)
      â””â”€â”€ camera_link
           â””â”€â”€ camera_depth_optical_frame
```

å¦‚éœ€åœ°å›¾ç´¯ç§¯åœ¨å…¨å±€åæ ‡ç³»ï¼Œéœ€è¦ç”±å¤–éƒ¨ç³»ç»Ÿæä¾› `map â†’ base_link` çš„å˜æ¢ã€‚

### ç‚¹äº‘æ•°æ®å¼‚å¸¸
```bash
# éªŒè¯è¯é¢˜
ros2 topic hz /camera/depth/color/points

# æ£€æŸ¥åæ ‡å˜æ¢
ros2 run tf2_tools view_frames
```

### ç³»ç»Ÿå·¥ä½œæ¨¡å¼è¯´æ˜

âœ… **å½“å‰é…ç½®ï¼šåŠ¨æ€è§‚æµ‹æ¨¡å¼**

ç³»ç»Ÿå·²ä¼˜åŒ–ä¸º **å®æ—¶è§‚æµ‹çª—å£**ï¼Œç‰¹æ€§å¦‚ä¸‹ï¼š
- âœ… åªæ˜¾ç¤ºç›¸æœºå½“å‰çœ‹åˆ°çš„ç‰©ä½“
- âœ… ç‰©ä½“ç§»èµ°å **<1 ç§’è‡ªåŠ¨æ¶ˆå¤±** âš¡
- âœ… ä¸ç§¯ç´¯å†å²æ•°æ®ï¼ˆé€‚åˆè§‚å¯Ÿé¢å‰ç‰©ä½“ï¼‰
- âœ… ä½è®¡ç®—ä»£ä»·ï¼ˆ5-10 Hz å®æ—¶æ›´æ–°ï¼‰

**æ¦‚ç‡æ¨¡å‹ï¼ˆè¶…å¿«æ¸…é™¤ + Pruneåˆ é™¤ï¼‰**ï¼š
- `hit: 0.97` â†’ æ£€æµ‹åˆ°æ—¶ç«‹å³å»ºç«‹
- `miss: 0.01` â†’ æœªæ£€æµ‹æ—¶**æé€Ÿé™æ¦‚ç‡**ï¼ˆæ¯å¸§-99%ï¼‰
- `min: 0.49` â†’ æ¦‚ç‡ä½äº0.5ï¼ˆå ç”¨é˜ˆå€¼ï¼‰åè¢«pruneåˆ é™¤
- `compress_map: true` â†’ **å…³é”®ï¼å¯ç”¨prune()æ‰ä¼šçœŸæ­£åˆ é™¤ä½“ç´ **

**å¦‚éœ€åˆ‡æ¢å›ç´¯ç§¯åœ°å›¾æ¨¡å¼**ï¼ˆé€‚åˆç§»åŠ¨æœºå™¨äººå»ºå›¾ï¼‰ï¼š
ç¼–è¾‘ [realsense_params.yaml](src/octomap_server2/config/realsense_params.yaml)
```yaml
sensor_model:
  hit: 0.7   # é™ä½ï¼ˆå‡æ…¢å»ºç«‹é€Ÿåº¦ï¼‰
  miss: 0.4  # æé«˜ï¼ˆä¿ç•™å†å²æ•°æ®ï¼‰
  min: 0.12  # é™ä½ï¼ˆä½“ç´ ä¸æ˜“æ¸…é™¤ï¼‰
compress_map: true  # å¯ç”¨å‹ç¼©å‚¨å­˜
```
**è°ƒèŠ‚æ¶ˆå¤±é€Ÿåº¦**ï¼ˆå¦‚éœ€æ›´æ…¢æˆ–æ›´å¿«ï¼‰ï¼š
- `miss: 0.01` + `compress_map: true` â†’ æå¿«æ¶ˆå¤±ï¼ˆ<1ç§’ï¼‰âš¡ **å½“å‰**
- `miss: 0.05` + `compress_map: true` â†’ å¿«é€Ÿæ¶ˆå¤±ï¼ˆ1-2ç§’ï¼‰
- `miss: 0.2` + `compress_map: true` â†’ ä¸­é€Ÿæ¶ˆå¤±ï¼ˆ3-5ç§’ï¼‰
- **å…³é”®**ï¼š`compress_map: true` å¿…é¡»å¯ç”¨ï¼Œå¦åˆ™ä½æ¦‚ç‡ä½“ç´ ä¸ä¼šè¢«åˆ é™¤ï¼
- é…åˆè°ƒæ•´ `min` å€¼ï¼ˆæ¥è¿‘0.5åˆ™æ›´æ˜“åˆ é™¤ï¼‰
**æ‰‹åŠ¨é‡ç½®åœ°å›¾**ï¼ˆå¦‚éœ€ç«‹å³æ¸…ç©ºï¼‰ï¼š
```bash
./reset_octomap.sh
```

## ğŸ“š æ–‡ä»¶ç»“æ„

```
/home/yq/ros2realsense/
â”œâ”€â”€ start_realsense_octomap.sh    â† æ¨èå¯åŠ¨è„šæœ¬
â”œâ”€â”€ run_performance_test.sh       â† æ€§èƒ½æµ‹è¯•
â”œâ”€â”€ README.md                     â† æœ¬æ–‡ä»¶
â”œâ”€â”€ colcon/                       â† ROS1 å…¼å®¹ï¼ˆå¯å¿½ç•¥ï¼‰
â””â”€â”€ src/
    â”œâ”€â”€ realsense-ros-4.57.6/    â† RealSense é©±åŠ¨
    â”œâ”€â”€ octomap_server2/         â† OctoMap æœåŠ¡å™¨
    â””â”€â”€ octomap_msgs/            â† æ¶ˆæ¯å®šä¹‰
```

## ğŸ”— å‚è€ƒèµ„æº

- [RealSense ROS](https://github.com/IntelRealSense/realsense-ros)
- [OctoMap æ–‡æ¡£](https://octomap.github.io/)
- [ROS 2 Humble](https://docs.ros.org/en/humble/)

## ğŸ“ æœ€æ–°æ›´æ–°

**2026-02-06**
- âœ… **åˆ‡æ¢ä¸ºåŠ¨æ€è§‚æµ‹æ¨¡å¼**ï¼ˆä¸ç§¯ç´¯å†å²ï¼Œåªæ˜¾ç¤ºå½“å‰ç‰©ä½“ï¼‰
- âœ… **è¶…å¿«æ¸…é™¤ä¼˜åŒ–**ï¼ˆhit: 0.97, miss: 0.01, min: 0.49 + pruneï¼‰â†’ ç§»èµ°ç‰©ä½“å **<1 ç§’æ¶ˆå¤±** âš¡
- âœ… ç¦ç”¨åœ°å›¾å‹ç¼©ï¼ˆåŠ¨æ€æ¨¡å¼æ— éœ€æŒä¹…åŒ–ï¼‰
- âœ… å‡çº§åˆ†è¾¨ç‡ä¸º 1280x720 @ 30fpsï¼ˆæ›´é«˜æ¸…ï¼‰
- âœ… Decimation ä¼˜åŒ–ä¸º 4xï¼ˆå‡å°‘ç‚¹äº‘æ•°é‡ï¼Œæå‡æ€§èƒ½ï¼‰
- âœ… æ·»åŠ  RealSense `clip_distance` ç‚¹äº‘è·ç¦»è£å‰ª
- âœ… è°ƒæ•´ OctoMap `sensor_model.min_range` ä¸º 0.0ã€`max_range` ä¸º 3.0m
- âœ… ä¿®å¤ RViz ç‚¹äº‘å †ç§¯é—®é¢˜ï¼ˆQoS Depth: 5â†’1ï¼Œæ¶ˆæ¯é˜Ÿåˆ—æ·±åº¦ä¼˜åŒ–ï¼‰
- âœ… ä¼˜åŒ–æ‰€æœ‰æ˜¾ç¤ºå™¨é…ç½®ï¼ˆPointCloud2 / OctoMap MarkerArray / 2D Projectionï¼‰
- âœ… æ·»åŠ åœ°å›¾é‡ç½®è„šæœ¬ï¼ˆ`reset_octomap.sh`ï¼‰
- âœ… æ›´æ–°å¯åŠ¨è„šæœ¬æ”¯æŒ clip_distance å‚æ•°
- âœ… æ·»åŠ åœ°å›¾å åŠ  / TF è¯´æ˜
- âœ… æ€§èƒ½ä¼˜åŒ–åˆ° 5-10 Hzï¼ˆå¿«é€Ÿæ¨¡å¼ï¼‰
- âœ… ç®€åŒ–å¯åŠ¨æµç¨‹
- âœ… æ¸…ç†å†—ä½™æ–‡æ¡£å’Œè„šæœ¬

**é¡¹ç›®çŠ¶æ€**: âœ… **åŠ¨æ€è§‚æµ‹æ¨¡å¼**ï¼ˆå®æ—¶æ˜¾ç¤ºå½“å‰ç‰©ä½“ï¼Œä¸ç§¯ç´¯å†å²ï¼‰  
**ROS ç‰ˆæœ¬**: Humble  
**ç›¸æœº**: RealSense D455  
**åˆ†è¾¨ç‡**: 1280x720 @ 30fpsï¼ˆDecimation=4 â†’ è¾“å‡º 320x180ï¼‰  
**è·ç¦»èŒƒå›´**: 0.0m - 3.0mï¼ˆclip_distance å¯è°ƒï¼‰  
**æ›´æ–°é¢‘ç‡**: 5-10 Hzï¼ˆç‰©ä½“ç§»èµ°å **<1 ç§’æ¶ˆå¤±** âš¡ï¼‰
